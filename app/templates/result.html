{% extends "base.html" %}

{% block content %}
<div class="container fade-in-up">
    <!-- Header with Back Button -->
    <div class="level mb-5">
        <div class="level-left">
            {% if session.get('batch_files') and session.get('batch_files')|length > 1 %}
            <a href="{{ url_for('main.batch_result') }}" class="button is-white has-text-grey">
                <span class="icon"><i class="fas fa-th"></i></span>
                <span>Back to Batch</span>
            </a>
            {% else %}
            <a href="{{ url_for('main.index') }}" class="button is-white has-text-grey">
                <span class="icon"><i class="fas fa-arrow-left"></i></span>
                <span>Back to Upload</span>
            </a>
            {% endif %}
        </div>
        <div class="level-right">
            <h2 class="title is-4 has-text-grey-dark">Analysis Result</h2>
        </div>
    </div>

    <div class="columns is-variable is-6">

        <!-- Left Column: Image & Actions -->
        <div class="column is-4">
            <div class="card p-1 mb-5 sticky-card">
                <div class="card-image">
                    <figure class="image is-4by3 confirm-img" style="border-radius: 0.5rem; overflow: hidden;">
                        <img src="{{ url_for('static', filename='uploads/' + filename) }}" alt="Analyzed Image"
                            style="object-fit: contain; background: #f0f2f5;">
                    </figure>
                </div>
                <div class="card-content">
                    <div class="content">
                        <p class="heading is-size-7 has-text-centered has-text-grey mb-4">
                            {{ filename[:20] }}...
                        </p>

                        <div class="field mb-4">
                            <label class="label">Global Compression Level</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select id="global-quality">
                                        <option value="100" selected>Best Quality (100%) - No Compression</option>
                                        <option value="90">High (90%) - Good for web</option>
                                        <option value="80">Medium (80%) - Balanced</option>
                                        <option value="60">Low (60%) - Small file size</option>
                                    </select>
                                </div>
                            </div>
                            <p class="help">Applies to Purify, Smart Clean, and Download.</p>
                        </div>

                        <div class="columns is-mobile is-multiline">
                            <div class="column is-12">
                                <form action="{{ url_for('main.purify', filename=filename) }}" method="POST">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                    <input type="hidden" name="quality" value="100">

                                    <button type="submit" class="button is-danger is-light is-fullwidth"
                                        title="Remove all EXIF data">
                                        <span class="icon"><i class="fas fa-soap"></i></span>
                                        <span>Purify & Clean</span>
                                    </button>
                                </form>
                            </div>
                            <div class="column is-12">
                                <button type="button" class="button is-primary is-fullwidth" id="download-btn">
                                    <span class="icon"><i class="fas fa-download"></i></span>
                                    <span>Download</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Smart Clean Card -->
            <div class="card mt-4 fade-in-up delay-100">
                <header class="card-header">
                    <p class="card-header-title has-text-info">
                        <span class="icon mr-2"><i class="fas fa-magic"></i></span>
                        Smart Clean
                    </p>
                </header>
                <div class="card-content">
                    <form action="{{ url_for('main.apply_template', filename=filename) }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="quality" value="100">
                        <div class="field">
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select name="template_name">
                                        {% for t in template_list %}
                                        <option value="{{ t }}">{{ t|capitalize }} Mode</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="field">
                            <button type="submit" class="button is-info is-light is-fullwidth">
                                <span>Optimize Metadata</span>
                            </button>
                        </div>
                        <p class="help is-size-7 has-text-centered">
                            Removes clutter but keeps useful tags for specific platforms.
                        </p>
                    </form>
                </div>
            </div>

            <!-- Watermark Card -->
            <div class="card mt-4 fade-in-up delay-100">
                <header class="card-header">
                    <p class="card-header-title has-text-link">
                        <span class="icon mr-2"><i class="fas fa-copyright"></i></span>
                        Watermark
                    </p>
                </header>
                <div class="card-content">
                    <form action="{{ url_for('main.watermark', filename=filename) }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <div class="field">
                            <label class="label is-small">Text</label>
                            <div class="control">
                                <input class="input is-small" type="text" name="watermark_text"
                                    placeholder="e.g. Â© 2026 Me" required>
                            </div>
                        </div>

                        <div class="field is-horizontal">
                            <div class="field-body">
                                <div class="field">
                                    <label class="label is-small">Position</label>
                                    <div class="control">
                                        <div class="select is-small is-fullwidth">
                                            <select name="watermark_position">
                                                <option value="center">Center</option>
                                                <option value="bottom-right" selected>Bottom Right</option>
                                                <option value="bottom-left">Bottom Left</option>
                                                <option value="top-right">Top Right</option>
                                                <option value="top-left">Top Left</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label is-small">Opacity</label>
                                    <div class="control">
                                        <div class="select is-small is-fullwidth">
                                            <select name="watermark_opacity">
                                                <option value="0.3">30%</option>
                                                <option value="0.5" selected>50%</option>
                                                <option value="0.8">80%</option>
                                                <option value="1.0">100%</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="field">
                            <button type="submit" class="button is-link is-light is-fullwidth">
                                <span>Apply Watermark</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- View Map Card -->
            <div class="card mt-4 fade-in-up delay-100">
                <header class="card-header">
                    <p class="card-header-title has-text-primary">
                        <span class="icon mr-2"><i class="fas fa-map-marked-alt"></i></span>
                        GPS Location
                    </p>
                </header>
                <div class="card-content p-0">
                    <div id="view-map" style="height: 250px; width: 100%;"></div>
                    {% if not lat or not lon %}
                    <div class="p-4 has-text-centered has-text-grey is-size-7">
                        No GPS data found. Use the editor to add location.
                    </div>
                    {% endif %}
                </div>
            </div>

        </div>

        <!-- Right Column: Data & Edit -->
        <div class="column is-8">

            <!-- Metadata Visualizer -->
            <div class="card mb-6 fade-in-up delay-100">
                <form action="{{ url_for('main.delete_selected', filename=filename) }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <header class="card-header level"
                        style="box-shadow: none; border-bottom: 1px solid #f1f5f9; padding-right: 1rem;">
                        <p class="card-header-title level-left">
                            <span class="icon mr-2 has-text-info"><i class="fas fa-list-ul"></i></span>
                            Metadata Viewer
                        </p>
                        <div class="level-right">
                            <button type="submit" class="button is-small is-danger is-outlined"
                                title="Delete selected tags">
                                <span class="icon is-small"><i class="fas fa-trash-alt"></i></span>
                                <span>Delete Selected</span>
                            </button>
                        </div>
                    </header>
                    <div class="card-content">
                        {% if exif_data %}
                        <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                            <table class="table is-hoverable is-fullwidth">
                                <tbody>
                                    {% for key, value in exif_data.items() %}
                                    {% if key not in ['GPSInfo', 'MakerNote', 'UserComment', 'Thinking'] %}
                                    <tr>
                                        <td style="width: 40px; vertical-align: middle;">
                                            <label class="checkbox">
                                                <input type="checkbox" name="selected_tags" value="{{ key }}">
                                            </label>
                                        </td>
                                        <td class="has-text-grey is-size-7" style="width: 30%; vertical-align: middle;">
                                            {{ key }}</td>
                                        <td class="has-text-weight-medium is-size-7 font-monospace"
                                            style="word-break: break-all; vertical-align: middle;">
                                            {{ value|string|truncate(100) }}
                                        </td>
                                    </tr>
                                    {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="notification is-light">
                            No standard EXIF data found.
                        </div>
                        {% endif %}
                    </div>
                </form>
            </div>

            <!-- Editor -->
            <div class="card fade-in-up delay-200" style="border-left: 4px solid var(--primary);">
                <header class="card-header" style="box-shadow: none;">
                    <p class="card-header-title">
                        <span class="icon mr-2 has-text-primary"><i class="fas fa-edit"></i></span>
                        Editor
                    </p>
                </header>
                <div class="card-content">
                    <form action="{{ url_for('main.edit', filename=filename) }}" method="POST" id="edit-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

                        <!-- Map Editor Section -->
                        <div class="mb-5">
                            <label class="label is-small">Geolocation (Click map to set)</label>
                            <div class="field has-addons">
                                <p class="control">
                                    <a class="button is-static is-small">Lat</a>
                                </p>
                                <p class="control is-expanded">
                                    <input class="input is-small" type="text" name="gps_lat" id="gps_lat"
                                        value="{{ lat if lat else '' }}" placeholder="Latitude">
                                </p>
                                <p class="control">
                                    <a class="button is-static is-small">Lon</a>
                                </p>
                                <p class="control is-expanded">
                                    <input class="input is-small" type="text" name="gps_lon" id="gps_lon"
                                        value="{{ lon if lon else '' }}" placeholder="Longitude">
                                </p>
                            </div>
                            <div id="edit-map"
                                style="height: 300px; width: 100%; border-radius: 4px; border: 1px solid #dbdbdb;">
                            </div>
                            <p class="help">Click anywhere on the map to place/move the marker.</p>
                        </div>

                        <hr style="background-color: #f1f5f9; height: 1px;">

                        <div class="columns">
                            <div class="column is-6">
                                <div class="field">
                                    <label class="label is-small">Artist / Creator</label>
                                    <div class="control has-icons-left">
                                        <input class="input is-small" type="text" name="Artist"
                                            placeholder="e.g. John Doe" value="{{ exif_data.get('Artist', '') }}">
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-user"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="column is-6">
                                <div class="field">
                                    <label class="label is-small">Copyright</label>
                                    <div class="control has-icons-left">
                                        <input class="input is-small" type="text" name="Copyright"
                                            placeholder="e.g. All rights reserved"
                                            value="{{ exif_data.get('Copyright', '') }}">
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-copyright"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="field">
                            <label class="label is-small">Image Description</label>
                            <div class="control">
                                <textarea class="textarea is-small" name="ImageDescription" rows="2"
                                    placeholder="Description of the image...">{{ exif_data.get('ImageDescription', '') }}</textarea>
                            </div>
                        </div>

                        <hr style="background-color: #f1f5f9; height: 1px;">

                        <div id="custom-fields-container" class="mb-4">
                            <!-- JS will inject rows here -->
                        </div>

                        <!-- Datalist for suggestions -->
                        <datalist id="tag-suggestions">
                            <option value="Make">
                            <option value="Model">
                            <option value="Software">
                            <option value="DateTime">
                            <option value="FNumber">
                            <option value="ExposureTime">
                            <option value="ISOSpeedRatings">
                            <option value="LensMake">
                            <option value="LensModel">
                            <option value="BodySerialNumber">
                            <option value="CameraOwnerName">
                            <option value="UserComment">
                        </datalist>

                        <div class="level is-mobile">
                            <div class="level-left">
                                <button type="button" class="button is-small is-ghost" id="add-field-btn">
                                    <span class="icon"><i class="fas fa-plus-circle"></i></span>
                                    <span>Add Field</span>
                                </button>
                            </div>
                            <div class="level-right">
                                <button type="submit" class="button is-primary shadow-md">
                                    <span class="icon"><i class="fas fa-save"></i></span>
                                    <span>Save Changes</span>
                                </button>
                            </div>
                        </div>

                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal" id="download-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Download Started</p>
            <button class="delete" aria-label="close" onclick="closeModal()"></button>
        </header>
        <section class="modal-card-body">
            <p>Your download has started.</p>
            <p>Do you want to finish this session (delete the file) or continue editing?</p>
        </section>
        <footer class="modal-card-foot">
            <form action="{{ url_for('main.finish', filename=filename) }}" method="POST" style="margin-right: 10px;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="button is-danger">Finish Session</button>
            </form>
            <button class="button" onclick="closeModal()">Continue Editing</button>
        </footer>
    </div>
</div>

<style>
    /* Local overrides for sticky behavior */
    @media screen and (min-width: 769px) {
        .sticky-card {
            position: sticky;
            top: 6rem;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // ---- Config & Initialization ----
        const filename = "{{ filename }}";
        const triggerDownload = {{ trigger_download| tojson
    }};
    const qualitySelect = document.getElementById('global-quality');
    const downloadBtn = document.getElementById('download-btn');
    const hiddenInputs = document.querySelectorAll('input[type="hidden"][name="quality"]');
    const modal = document.getElementById('download-modal');

    // ---- Functions ----

    function getDownloadUrl() {
        // Base URL
        const baseUrl = "{{ url_for('main.download', filename=filename) }}";

        // Check quality if selector exists
        if (qualitySelect) {
            const quality = qualitySelect.value;
            if (quality < 100) {
                return `${baseUrl}?quality=${quality}`;
            }
        }
        return baseUrl;
    }

    function triggerFileDownload(url) {
        const link = document.createElement('a');
        link.href = url;
        link.download = ''; // Force download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function showDownloadModal() {
        if (modal) modal.classList.add('is-active');
    }

    function closeModal() {
        if (modal) modal.classList.remove('is-active');
    }

    // Expose to window for inline onclicks if any
    window.closeModal = closeModal;

    // ---- Event Listeners ----

    // 1. Manual Download Click
    if (downloadBtn) {
        downloadBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const url = getDownloadUrl();
            triggerFileDownload(url);
            showDownloadModal();
        });
    }

    // 2. Auto Download (from redirect)
    if (triggerDownload) {
        // Provide a small delay to ensure UI renders
        setTimeout(() => {
            const url = getDownloadUrl();
            // Note: Auto-download usually means we accept the current state.
            // However, reusing getDownloadUrl() respects the default state of the dropdown (usually 100).
            triggerFileDownload(url);
            showDownloadModal();
        }, 500);
    }

    // 3. Modal Background Click
    const bg = document.querySelector('.modal-background');
    if (bg) bg.addEventListener('click', closeModal);

    // 4. Quality Selector Change
    if (qualitySelect) {
        qualitySelect.addEventListener('change', () => {
            const quality = qualitySelect.value;
            // Update hidden inputs for other forms (Purify/Template)
            hiddenInputs.forEach(input => {
                input.value = quality;
            });
        });

        // Initialize hidden inputs
        const quality = qualitySelect.value;
        hiddenInputs.forEach(input => {
            input.value = quality;
        });
    }

    // ---- Map Logic ----
    const latStr = "{{ lat if lat else 'null' }}";
    const lonStr = "{{ lon if lon else 'null' }}";
    const lat = (latStr === 'null') ? null : parseFloat(latStr);
    const lon = (lonStr === 'null') ? null : parseFloat(lonStr);
    const hasLocation = (lat !== null && lon !== null);
    const defaultCenter = [48.8566, 2.3522];
    const initialCenter = hasLocation ? [lat, lon] : defaultCenter;
    const initialZoom = 13;

    // View Map
    if (document.getElementById('view-map') && hasLocation) {
        const map = L.map('view-map').setView(initialCenter, initialZoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        L.marker(initialCenter).addTo(map);
    }

    // Edit Map
    if (document.getElementById('edit-map')) {
        const editMap = L.map('edit-map').setView(initialCenter, initialZoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(editMap);

        let marker = null;
        if (hasLocation) {
            marker = L.marker(initialCenter, { draggable: true }).addTo(editMap);
        }

        const latInput = document.getElementById('gps_lat');
        const lonInput = document.getElementById('gps_lon');

        editMap.on('click', function (e) {
            const coord = e.latlng;
            if (marker) {
                marker.setLatLng(coord);
            } else {
                marker = L.marker(coord, { draggable: true }).addTo(editMap);
            }
            latInput.value = coord.lat.toFixed(6);
            lonInput.value = coord.lng.toFixed(6);
        });

        if (marker) {
            marker.on('dragend', function (e) {
                const coord = marker.getLatLng();
                latInput.value = coord.lat.toFixed(6);
                lonInput.value = coord.lng.toFixed(6);
            });
        }
    }
    });
</script>
{% endblock %}